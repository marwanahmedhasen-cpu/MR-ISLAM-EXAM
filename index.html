<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Math Portal</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f6fb; margin:20px; }
h1,h2,h3 { text-align:center; }
.hidden { display:none; }
.container { max-width:800px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
input, select, textarea, .essayBox { width:100%; margin:8px 0; padding:8px; border:1px solid #ccc; border-radius:6px; }
button { background:#3498db; color:white; border:none; padding:10px 15px; margin-top:10px; border-radius:6px; cursor:pointer; }
button:hover { background:#217dbb; }
.adminBtn { position:fixed; bottom:10px; right:10px; background:#e74c3c; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:14px; }
.signsBtn { position:fixed; bottom:60px; right:10px; background:#f39c12; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:14px; }
.signsPanel { position:fixed; bottom:110px; right:10px; background:white; border:1px solid #ccc; border-radius:6px; padding:10px; display:none; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
.signsPanel button { background:#3498db; color:white; margin:3px; padding:6px 10px; font-size:16px; }
.question { margin:15px 0; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fafafa; }
.essayBox { min-height:50px; outline:none; border:1px solid #ccc; border-radius:6px; padding:6px; }
.correct { color:green; font-weight:bold; }
.wrong { color:red; font-weight:bold; }
.essayTools { margin:5px 0; }
.essayTools button { background:#2ecc71; }
</style>
</head>
<body>
<div class="container">
<h1>Welcome to the Math Portal</h1>

<!-- Student Info -->
<div id="studentInfo">
<label>Full Name:</label>
<input type="text" id="studentName" required>
<label>Select Your Grade:</label>
<select id="studentGrade">
<option value="">-- Select --</option>
<option value="Grade4">Grade 4</option>
<option value="Grade5">Grade 5</option>
<option value="Grade6">Grade 6</option>
<option value="Prep1">Prep 1</option>
<option value="Prep2">Prep 2</option>
<option value="Prep3">Prep 3</option>
<option value="Sec1">Sec 1</option>
<option value="Sec2">Sec 2</option>
</select>
<button onclick="startExam()">Start Exam</button>
</div>

<!-- Exam Area -->
<div id="examArea" class="hidden">
<h2>Exam</h2>
<form id="examForm"></form>
<button type="button" onclick="submitExam()">Submit Answers</button>
<div id="results"></div>
</div>

<!-- Admin Login -->
<div id="loginPanel" class="hidden">
<h2>Admin Login</h2>
<input type="password" id="adminPassword" placeholder="Enter admin password">
<button onclick="checkLogin()">Login</button>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden">
<h2>Admin Panel - Manage Questions</h2>
<label>Select Grade:</label>
<select id="adminGrade"></select>
<h3>Multiple Choice Questions</h3>
<div id="mcqEditor"></div>
<button type="button" onclick="addMCQ()">+ Add MCQ</button>
<h3>Essay Questions</h3>
<div id="essayEditor"></div>
<button type="button" onclick="addEssay()">+ Add Essay</button>
<button type="button" onclick="saveQuestions()">Save Questions</button>
</div>
</div>

<!-- Floating Buttons -->
<div class="adminBtn" onclick="showLogin()">Admin</div>
<div class="signsBtn" onclick="toggleSigns()">Signs</div>

<!-- Math Signs Panel -->
<div class="signsPanel" id="signsPanel">
<button onclick="insertSign('±')">±</button>
<button onclick="insertSign('+')">+</button>
<button onclick="insertSign('-')">-</button>
<button onclick="insertSign('×')">×</button>
<button onclick="insertSign('÷')">÷</button>
<button onclick="insertSign('=')">=</button>
<button onclick="insertSign('√')">√</button>
<button onclick="insertSign('π')">π</button>
<button onclick="insertSign('i')">i</button>
</div>

<script>
const ADMIN_PASS="ESLAM!123";
const FORM_ENDPOINT="https://formspree.io/f/xblzywjo";

let questionBank = JSON.parse(localStorage.getItem("questionBank") || "{}");
const grades = ["Grade4","Grade5","Grade6","Prep1","Prep2","Prep3","Sec1","Sec2"];
const adminGradeSelect=document.getElementById("adminGrade");

grades.forEach(g=>{
  let opt=document.createElement("option");
  opt.value=g; opt.textContent=g;
  adminGradeSelect.appendChild(opt);
});

// === Admin Functions ===
function showLogin(){ document.getElementById("loginPanel").classList.toggle("hidden"); }
function checkLogin(){ 
  const pass=document.getElementById("adminPassword").value;
  if(pass===ADMIN_PASS){ 
    document.getElementById("loginPanel").classList.add("hidden"); 
    document.getElementById("adminPanel").classList.remove("hidden"); 
    loadEditors(); 
  }
  else alert("Wrong password!"); 
}
function addMCQ(){
  let div=document.createElement("div"); div.className="question";
  div.innerHTML=`<input type="text" placeholder="Question text">
  <input type="text" placeholder="Option A">
  <input type="text" placeholder="Option B">
  <input type="text" placeholder="Option C">
  <input type="text" placeholder="Option D">
  <label>Correct Answer (A/B/C/D):</label>
  <input type="text" maxlength="1">`;
  document.getElementById("mcqEditor").appendChild(div);
}
function addEssay(){
  let div=document.createElement("div"); div.className="question";
  div.innerHTML=`
    <div contenteditable="true" class="essayBox" placeholder="Essay Question"></div>
    <div class="essayTools">
      <button type="button" onclick="insertImage(this)">Insert Image</button>
    </div>`;
  document.getElementById("essayEditor").appendChild(div);
}
function saveQuestions(){
  const grade=adminGradeSelect.value; if(!grade) return alert("Select a grade");
  let mcqs=[...document.querySelectorAll("#mcqEditor .question")].map(q=>{
    let inputs=q.querySelectorAll("input");
    return {q:inputs[0].value,a:inputs[1].value,b:inputs[2].value,c:inputs[3].value,d:inputs[4].value,correct:inputs[5].value.toUpperCase()};
  });
  let essays=[...document.querySelectorAll("#essayEditor .essayBox")].map(i=>i.innerHTML);
  questionBank[grade]={mcq:mcqs, essay:essays};
  localStorage.setItem("questionBank", JSON.stringify(questionBank));
  alert("Saved for "+grade); 
  document.getElementById("adminPanel").classList.add("hidden");
}
function loadEditors(){
  document.getElementById("mcqEditor").innerHTML=""; 
  document.getElementById("essayEditor").innerHTML="";
  const grade=adminGradeSelect.value;
  if(!grade || !questionBank[grade]) return;
  questionBank[grade].mcq.forEach(m=>{
    addMCQ(); 
    let inputs=document.querySelectorAll("#mcqEditor .question:last-child input"); 
    inputs[0].value=m.q; inputs[1].value=m.a; inputs[2].value=m.b; inputs[3].value=m.c; inputs[4].value=m.d; inputs[5].value=m.correct; 
  });
  questionBank[grade].essay.forEach(e=>{
    addEssay(); 
    document.querySelector("#essayEditor .question:last-child .essayBox").innerHTML=e; 
  });
}
adminGradeSelect.addEventListener("change", loadEditors);

// === Exam ===
function startExam(){
  let name=document.getElementById("studentName").value.trim();
  let grade=document.getElementById("studentGrade").value;
  if(!name||!grade) return alert("Enter name and grade");
  if(!questionBank[grade]) return alert("No questions set for this grade yet");
  document.getElementById("studentInfo").classList.add("hidden");
  document.getElementById("examArea").classList.remove("hidden");
  renderExam(grade);
}
function renderExam(grade){
  let form=document.getElementById("examForm"); form.innerHTML="";
  questionBank[grade].mcq.forEach((m,i)=>{
    let div=document.createElement("div"); div.className="question";
    div.innerHTML=`<p>${i+1}. ${m.q}</p>
    <label><input type="radio" name="mcq${i}" value="A"> ${m.a}</label><br>
    <label><input type="radio" name="mcq${i}" value="B"> ${m.b}</label><br>
    <label><input type="radio" name="mcq${i}" value="C"> ${m.c}</label><br>
    <label><input type="radio" name="mcq${i}" value="D"> ${m.d}</label>`;
    form.appendChild(div);
  });
  questionBank[grade].essay.forEach((e,i)=>{
    let div=document.createElement("div"); div.className="question";
    div.innerHTML=`<p>Essay ${i+1}: ${e}</p>
    <div contenteditable="true" class="essayBox"></div>
    <div class="essayTools"><button type="button" onclick="insertImage(this)">Insert Image</button></div>`;
    form.appendChild(div);
  });
}
async function submitExam(){
  const grade=document.getElementById("studentGrade").value;
  const name=document.getElementById("studentName").value;
  let score=0, total=questionBank[grade].mcq.length;
  let answers={mcq:[], essay:[]};
  questionBank[grade].mcq.forEach((m,i)=>{
    let selected=document.querySelector(`input[name="mcq${i}"]:checked`);
    if(selected && selected.value===m.correct) score++;
    answers.mcq.push(selected?selected.value:"No Answer");
  });
  document.querySelectorAll("#examForm .essayBox").forEach((box,i)=>{
    answers.essay.push({q:questionBank[grade].essay[i],ans:box.innerHTML});
  });

  document.getElementById("results").innerHTML=`<h3>Results</h3>
    <p>Score: ${score}/${total}</p>`;

  const formData=new FormData();
  formData.append("studentName",name);
  formData.append("grade",grade);
  formData.append("score",`${score}/${total}`);
  formData.append("mcqAnswers",answers.mcq.join(", "));
  formData.append("essays",answers.essay.map((e,i)=>`Q${i+1}: ${e.q}\nAnswer: ${e.ans}`).join("\n\n"));
  try{
    await fetch(FORM_ENDPOINT,{method:"POST",body:formData,headers:{"Accept":"application/json"}});
    alert("Exam submitted successfully!");
  }catch(e){alert("Error sending exam: "+e.message);}
}

// === Image insert helper ===
function insertImage(btn){
  let essayBox=btn.closest(".question").querySelector(".essayBox");
  let input=document.createElement("input");
  input.type="file"; input.accept="image/*";
  input.onchange=()=>{
    let file=input.files[0]; if(!file) return;
    let reader=new FileReader();
    reader.onload=e=>{
      let img=document.createElement("img");
      img.src=e.target.result; img.style.maxWidth="200px"; img.style.display="block"; img.style.margin="5px 0";
      essayBox.appendChild(img);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

// === Signs Panel ===
let activeInput = null;
document.addEventListener("focusin", e=>{
  if(e.target.tagName==="INPUT" || e.target.tagName==="TEXTAREA" || e.target.isContentEditable){
    activeInput = e.target;
  }
});
function toggleSigns(){
  const panel=document.getElementById("signsPanel");
  panel.style.display = panel.style.display==="block" ? "none" : "block";
}
function insertSign(sign){
  if(!activeInput) return alert("Click inside a field or essay first!");
  insertAt(activeInput, sign);
}
function insertAt(el, text){
  el.focus();
  if(el.isContentEditable){
    let sel = window.getSelection(), range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(document.createTextNode(text));
    range.collapse(false);
    sel.removeAllRanges(); sel.addRange(range);
  } else {
    let start=el.selectionStart, end=el.selectionEnd;
    el.value = el.value.slice(0,start) + text + el.value.slice(end);
    el.selectionStart = el.selectionEnd = start+text.length;
  }
}
</script>
</body>
</html>
